# Azure-VirtualMachine
### ‚úÖ `README.md`

```markdown
# üåê Azure Virtual Machine Deployment with Terraform & GitHub Actions

This project automates the provisioning of an **Azure Virtual machine** using Terraform. It integrates with **GitHub Actions** to create a CI/CD pipeline that applies infrastructure changes upon pushing to the `main` branch. Also displays the cost of resources used using INFRACOST and creates the resources only after the approval from reviewers.

---
## ‚öôÔ∏è Prerequisites

- Azure Subscription
- [Azure CLI](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli)
- [Terraform](https://developer.hashicorp.com/terraform/install)
- GitHub Repository
- Remote Backend in Azure portal for statefile storage
- Infracost API Key to estimate cost of resources
---
## üîê Setup Azure Remote Backend 
   For Remote backend you need to create Resource Group, Storage Account, Container.

1. **Resource group creation from AZURE Portal**
    Go to Azure Portal-->Search for ‚ÄúResource groups‚Äù-->Click ‚Äú+ Create‚Äù-->Name: tfstate-rg/your prefferd name-->
    Region: East US/default region -->Click Review + Create --> Create

    by these steps Resource group will be created

2. **Storage account creation from AZURE Portal**
   Search ‚ÄúStorage accounts‚Äù-->Click ‚Äú+ Create‚Äù --> Resource Group: tfstate-rg/your prefferd name -->Storage account name: tfstatestorageacct111 (must be unique) --> Region: Same as above --> Click Review + Create --> Create

   by these steps storage account will be created

3. **Container creation from AZURE Portal**
   Open the storage account which you created -->In the left menu, under data storage, click ‚ÄúContainers‚Äù -->
   Click ‚Äúadd Container‚Äù Name: tfstate --> create

   Once above are created terraform.tfstate file will be stored under container file(generated by keyvalue input) rather than in workflow


## üîê Setup Azure Authentication (Service Principal)

1a. **Create a Service Principal** with Contributor access from CLI

   ```bash
   az ad sp create-for-rbac --role="Contributor" \
     --scopes="/subscriptions/<YOUR_SUBSCRIPTION_ID>" \
     --sdk-auth
````
1b. **Create a Service Principal** with Contributor access from Azure Portal
```
   Login to azure portal --> search for Microsoft entra id --> under manage navigate to App Registrations -->
   click on New Registration and provide necesary details and click Register

````
2a. **Save the following values from the output** into your GitHub repo under:

   **GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret**

   | GitHub Secret Name    | Value from SP Output |
   | --------------------- | -------------------- |
   | `ARM_CLIENT_ID`       | `clientId`           |
   | `ARM_CLIENT_SECRET`   | `clientSecret`       |
   | `ARM_SUBSCRIPTION_ID` | `subscriptionId`     |
   | `ARM_TENANT_ID`       | `tenantId`           |

2b. **Save the following values from the output** into your GitHub repo under:

    **GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret**

    | GitHub Secret Name    | Value from SP Output                 |
    | --------------------- | ------------------------------------ |
    | `AZURE_CREDENTIALS`   | Provide All Above Secrets in this    |

3a. generate SSH Public key and provide it in github secrets

   use below cmnd in terminal
   ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
    
   with above cmnd two files will be generated and you have to provide .pub files key in secrets
   **GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret**
     | GitHub Secret Name    | Value from SP Output                 |
    | --------------------- | ------------------------------------ |
    | `SSH_PUBLIC_KEY`      | provide .pub files value here        |


## üîê Setup INFRACOST API KEY

   Install INFRACOST CLI --> using command prompt navigate to directory where infracost is stored ( C:\Windows ) -->
   give command "infracost auth login" --> generate API key using "infracost configure get api_key" --> and save generated key locally


## üîê Setup GITHUB Environments for manual approval
   
1. first step to add collaborators
   Go to your repo --> Settings --> Collaborators -->Click "Invite a collaborator" -->Enter your teammate‚Äôs GitHub username -->
   Choose appropriate access (usually Write or Admin) --> Send invite --> your teammates github account will be added under collaborators
   Note: If you're the owner, you cannot add yourself ‚Äî you already have full access.

2. Next Add a GitHub Environment
   Go to Settings ‚Üí Environments --> Click "New environment", name it dev or prod -->Under "Deployment protection rules", click "Required reviewers" --> Add your GitHub username/teammates username for approval --> Click Save
   This will enforce manual approval before applying infrastructure.

---

## üöÄ CI/CD Pipeline (GitHub Actions)

**File:** `.github/workflows/deploy.yml`

## Project Structure

```
.github/
  workflows/
    deploy.yml
terraform/
  environments/
    dev/
      backend.tf
      main.tf
      variables.tf
      terraform.tfvars
    prod/
      backend.tf
      main.tf
      variables.tf
      terraform.tfvars
  modules/
    /VM
      main.tf
      outputs.tf
      providers.tf
      terarform.tfvars
      variables.tf


### üí° Pipeline Features:

* Runs on push or workflow_dispatch request to `main` branch
* Validates, plans, and applies infrastructure
* Authenticates securely with GitHub secrets

## Triggering the Pipeline
   
1. For Push event workflows

   Simply push a change to the `main` branch:
   git add .
   git commit -m "Name you want to provide "
   git push -u origin main
   Check progress under GitHub ‚Üí Actions tab.

2. For workflow_dispatch events
   
   Simply push a change to the `main` branch:
   git add .
   git commit -m "Name you want to provide "
   git push -u origin main
   Go to Actions --> Terraform Azure keyvault --> Run workflow tab will be added -->Select the envronment prod or dev -->
   Enter input yes --> workflow will be triggered based on the input provided in yml file.

   Workflow Execution:
   First Terraform plan will execute, and stores the plan on output file, then INFRACOST will read that output file, and estimates the overall cost of the resources included in output file and displays it and also generates seperate file for reference and download.

   Once Terraform plan is executed and successful, then workflow goes to Terraform apply step and sends mail for approval to the person we provided in github environments, once apply step is reviewed and approved by teammember/lead then only Terraform apply step will trigger and deploys resources.

---
## üõ†Ô∏è Customization Options

You can override default settings via `terraform.tfvars` or CLI flags:

```hcl
resource_group_name        = "VMResource"
resource_group_location    = "West Europe"
vnet_name                  = "VM-network"
vnet_address_space         = ["10.0.0.0/16"]
subnet_name                = "VM-subnet"
subnet_address_prefixes    = ["10.0.2.0/24"]
nic_name                   = "VM-nic"
vm_name                    = "Linux-machine"
vm_size                    = "Standard_F2"
admin_username             = "adminuser"

```

Or pass them via CLI:

```bash
terraform apply \
  -var="resource_group_name=VMResource" \
  -var="resource_group_location=West Europe" \
  -var="vnet_name=VM-network" \
  -var='vnet_address_space=["10.0.0.0/16"]' \
  -var="subnet_name=VM-subnet" \
  -var='subnet_address_prefixes=["10.0.2.0/24"]' \
  -var="nic_name=VM-nic" \
  -var="vm_name=Linux-machine" \
  -var="vm_size=Standard_F2" \
  -var="admin_username=adminuser" \


```

---

## üì§ Terraform Outputs

After successful deployment, you‚Äôll get:

| Output                    | Description                                          |
| ------------------------- | ---------------------------------------------------- |
| `resource_group_name`     | The generated Azure resource group name              |
| `resource_group_location` | Location in which it is deployed                     |
| `Virtual Network`         | Generated Virtual Network name                       |
| `Subnet`                  | Generated subnet fro Vnet                            |
| `Virtual Machine`         | Generated Virtual machine                            |
---


## üßπ Cleanup

To destroy all resources:

```bash
terraform destroy -auto-approve
```

---

## üß† Learn More

* [Azure Recovery Vault Documentation](https://learn.microsoft.com/en-us/azure/virtual-machines/)
* [Azure Recovery Vault creation using terraform](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-terraform)
* [Terraform AzureRM Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
* [GitHub Actions for Terraform](https://github.com/hashicorp/setup-terraform)

---
